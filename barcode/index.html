<!DOCTYPE html>
<html>
<head>
	<title>Barcode Test</title>
	<meta charset="utf-8">
	<style type="text/css">
		body {
			font-size: 1.6em;
		}

		.hidden {
			display: none;
		}

		.show {
			display: inline !important;
		}

		button {
			border: 2px solid black;
			background: #E5E4E2;
			font-size: .5em;
			font-weight: bold;
			color: black;
			padding: .8em 2em;
			margin-top: .4em;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

</head>
<body>
	<form action="javascript:void(0);" id="forms">
		Input: <br />
		<input type="text" id="input" ><br />
		<input type="submit" value="Submit" id="submit"><br/>	
	</form>

	<p id="scan"></p>

	<script>

        // FIXME -- eliminate global variables if possible, but for now more descriptive variables and some explanation.
		var barcodeScannerData = "";// The raw data read from the scanner

        /**
         * When the document registers a keypress, determine if the keys pressed are coming from the barcode scanner.
         */
		$(document).keypress(function(event) {

		    const scannerPrefix = "{BAR}";
            let keyPressedWasEnter = event.key === "Enter";

            if (!keyPressedWasEnter) {
                barcodeScannerData += event.key;
                console.log(event.key.charCodeAt(0));
            } else {
                let inputIsActive = document.activeElement.tagName !== "INPUT";
                let detectedScannerPrefix = false;
                if (!inputIsActive && detectedScannerPrefix) {
                    document.getElementById("scan").innerHTML = barcodeScannerData.slice(1) + " Scanner detected no form";
                    barcodeScannerData = "";
                    // Otherwise clear the dataScan variable
                } else {
                    barcodeScannerData = "";
                    event.preventDefault();
                    return false;
                }
            }
            return true;
        });

        /**
         * When the form's submit button is clicked, determine the source of barcode input and respond accordingly.
         */
		document.getElementById("submit").onclick = function(event){
			let formInputData = document.getElementById("input").value;
			if (formInputData.startsWith("{BAR}")) {  // FIXME -- this is a fragile way to check where the data came from
                                               // Is there a way to do better?
				document.getElementById("scan").innerHTML = formInputData.slice(5) + " Scanner detected from form";
        
			} else {
				document.getElementById("scan").innerHTML = formInputData + " Came from user ";
			}


			// Finally reset the data variable and the contents of the form field
            // FIXME -- this should be a separate event handler, eventually in the controller
			formInputData = "";
			let inputElements = document.getElementsByTagName('input');
  			for (let i = 0; i < inputElements.length; i++) {
 				if (inputElements[i].type === "text") {
  					  inputElements[i].value = "";
			  	}
 			}
		};

	</script>

</body >
</html >
