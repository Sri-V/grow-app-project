<!DOCTYPE html>
<html>
<head>
	<title>test2</title>
	<meta charset="utf-8">
	<style type="text/css">
		body {
			font-size: 1.6em;
		}

		.hidden {
			display: none;
		}

		.show {
			display: inline !important;
		}

		button {
			border: 2px solid black;
			background: #E5E4E2;
			font-size: .5em;
			font-weight: bold;
			color: black;
			padding: .8em 2em;
			margin-top: .4em;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>


	<form action = "#" id="forms">
		Input: <br />
		<input type="text" id="input" ><br />
		<input type="submit" value="Submit" id="submit"><br/>
		<p id="scan"></p>
	</form>

	<script>

        // FIXME -- eliminate global variables if possible: consider using CustomEvent.detail to pass data to a handler
		var data = ""; // The raw data read in from the scanner
		var focused = false; // Is the input focused?

        /**
         * Decodes the character input from the KeyPress event.
         * @param event A KeyPress Event
         * @returns String or null.
         */
		function getChar(event) {
		    // FIXME -- Event.which is deprecated according to MDN. Can we replace it?
		    // If a numeric code doesn't exist on this event
  			if (event.which == null) {
  			    // Take the keyCode and convert it to a String
    			return String.fromCharCode(event.keyCode);
            // Otherwise if the numeric code isn't zero and the character code isn't zero
  			} else if (event.which!==0 && event.charCode!==0) {
                // Take the charCode and convert it to a string
                return String.fromCharCode(event.which);
            // Otherwise return null
  			} else {
    			return null; // FIXME -- encoding an error using null is fragile. We should throw an error instead.
  			}	
		}

        /**
         * On keypress in the input tag, get characters from input and store it in a variable.
         */
		document.getElementById('input').onkeypress = function(event) {
  			let char = getChar(event || window.event); // FIXME -- what does this condition check for?
 			 if (!char) { // FIXME -- this should accept an error instead
				  alert("special key");
				  // FIXME -- Need to reset the data in the form field so user can access it again
				  return false; 
			}
			data += char;
            return true;
		};

        /**
         * When the input tag is in focus for the user, set focus equal to true.
         * FIXME -- This shouldn't exist as a state variable.
         * Try https://stackoverflow.com/questions/36430561/how-can-i-check-if-my-element-id-has-focus
         *   and/or https://developer.mozilla.org/en-US/docs/Web/API/Document/hasFocus for ways to programmatically
         *   check element focus.
         */
		document.getElementById('input').onfocus = function(event) {
			focus = true;
		}

	</script>
		
	<script>

        // FIXME -- eliminate global variables if possible, but for now more descriptive variables and some explanation.
		var dataScan = "";
		var det = false;

        /**
         * When the document registers a keypress, get the data from the scanner if the form field is not focused.
         */
		$(document).keypress(function(e){

		    // FIXME -- what do these condition checks mean?
			if (e.keyCode === 2) {
                det = true;
                dataScan = "";
			} else {
				let char = getChar(event || window.event);
 			 	if (!char) {
				  alert("special key");
				  return false; 
				}
				 dataScan += char;
			}

			if (e.keyCode === 13 && !focused && det) {
				document.getElementById("scan").innerHTML = dataScan + "scanner detected no form";
				//$("body").append(dataScan);
				dataScan = "";
				det = false;
			}
		});
		
	</script>

	<script>

        /**
         * When the form's submit button is clicked, determine the source of barcode input and respond accordingly.
         */
		document.getElementById("submit").onclick = function(event){
			if (data.charCodeAt(0) !== 002) {  // FIXME -- this is a fragile way to check where the data came from
                                               // Is there a way to do better?
				document.getElementById("scan").innerHTML = data + " came from user ";
			} else {
				document.getElementById("scan").innerHTML = data.slice(1) + "scanner detected from form";
			}


			// Finally reset the data variable and the contents of the form field
            // FIXME -- this should be a separate event handler, eventually in the controller
			data = "";
			let inputElements = document.getElementsByTagName('input');
  			for (let i = 0; i < inputElements.length; i++) {
 				if (inputElements[i].type == "text") {
  					  inputElements[i].value = "";
			  	}
 			}
		};

	</script>

</body >
</html >
